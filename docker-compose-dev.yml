version: '2'
services:
    nginx-proxy:
     image: jwilder/nginx-proxy
     container_name: nginx-proxy-dev
     ports:
         - "80:80"
     volumes:
         - /var/run/docker.sock:/tmp/docker.sock:ro
    public:
     image: dmitrovskiy/docker-nginx-php-fpm:1.0.0-alpine
     container_name: app-public
     environment:
         - VIRTUAL_HOST=public.site.org
     volumes:
         - ./modules/public/app:/var/www/html/web
         - ./modules/public/src/default.conf:/etc/nginx/conf.d/default.conf
    paypal:
     image: dmitrovskiy/docker-nginx-php-fpm:1.0.0-alpine
     container_name: app-paypal
     environment:
         - VIRTUAL_HOST=paypal.site.org
     volumes:
         - ./modules/paypal/app:/var/www/html/web
         - ./modules/paypal/src/default.conf:/etc/nginx/conf.d/default.conf
    reports:
     image: dmitrovskiy/docker-nginx-php-fpm:1.0.0-alpine
     container_name: app-reports
     environment:
         - VIRTUAL_HOST=reports.site.org
     volumes:
         - ./modules/reports/app:/var/www/html/web
         - ./modules/reports/src/default.conf:/etc/nginx/conf.d/default.conf
    invoice-dev:
     image: dmitrovskiy/docker-nginx-php-fpm:1.0.0-alpine # orionla2/invoice_microservice:latest
     container_name: app-invoice
     environment:
         - VIRTUAL_HOST=invoice.site.org
     volumes:
         - ./modules/invoice/app:/var/www/html/web
         - ./modules/invoice/src/default.conf:/etc/nginx/conf.d/default.conf
    rabbit:
     image: dmitrovskiy/docker-nginx-php-fpm:1.0.0-alpine # orionla2/invoice_microservice:latest
     container_name: app-rabbit-mq
     volumes:
         - ./modules/rabbitmq/app:/var/www/html/web
         - ./modules/rabbitmq/src/default.conf:/etc/nginx/conf.d/default.conf
     environment:
         - VIRTUAL_HOST=rabbit.site.org
    postgresql:
     image: postgres
     container_name: postgresql
     ports:
         - "5432:5432"
     environment:
         - "POSTGRES_USER=postgres"
         - "POSTGRES_PASSWORD=1q2w3e4r"
         - "POSTGRES_DB=postgres"
     volumes:
         - ./srv/docker/postgresql/data:/var/lib/postgresql/data
         - ./srv/docker/db_backup:/home
    schema_setup:
        build: ./modules/migration
        image: schema_setup
        container_name: schema
        environment:
         - "POSTGRES_USER=postgres"
         - "POSTGRES_PASSWORD=1q2w3e4r"
         - "POSTGRES_DB=postgres"
         - "PGHOST=target_service"
         - "PGPASSWORD=1q2w3e4r"
         - "SQITCH_BUNDLE_REPO=https://github.com/anddorua/ymigration.git"
        links:
         - postgresql:target_service
        #volumes:
        # - /app:/src
        depends_on:
         - postgresql
        command: /src/start.sh
    postgrest:
     build: dockerfiles/main
     container_name: postgrest
     environment:
         - "POSTGREST_VERSION=0.3.2.0"
         - "POSTGREST_DBHOST=postgresql-dev"
         - "POSTGREST_DBPORT=5432"
         - "POSTGREST_DBNAME=postgres"
         - "POSTGREST_ANONYMOUS=guest"
         - "POSTGREST_DBUSER=authenticator"
         - "POSTGREST_SCHEMA=my_yacht"
         - "POSTGREST_DBPASS=password"
         - "POSTGREST_PORT=80"
         - VIRTUAL_HOST=site.org
     links:
         - postgresql:postgresql
     depends_on:
         - postgresql
